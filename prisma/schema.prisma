// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String   // hashed password
  email     String?  @unique // optional for now
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  sessions     PracticeSession[]
  reflections  Reflection[]
  scores       PhaseScore[]
  dailyPlans   DailyPlan[]
  customProblems CustomProblem[]
  reviewSessions ReviewSession[]
  analytics    UserAnalytics?

  @@map("users")
}

model Problem {
  id          String   @id @default(cuid())
  slug        String   @unique
  title       String
  difficulty  Difficulty
  patterns    Json     // Array of pattern names
  cues        Json     // Array of cue descriptions
  description String
  examples    Json     // Array of example objects
  constraints Json     // Array of constraint strings
  isCustom    Boolean  @default(false)
  createdBy   String?  // User ID for custom problems
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relationships
  sessions       PracticeSession[]
  testCases      TestCase[]
  customProblems CustomProblem[]

  @@map("problems")
}

model TestCase {
  id        String  @id @default(cuid())
  problemId String
  input     String
  expected  String
  weight    Float   @default(1.0)
  isExample Boolean @default(false)

  // Relationships
  problem Problem @relation(fields: [problemId], references: [id], onDelete: Cascade)

  @@map("test_cases")
}

model PracticeSession {
  id        String   @id @default(cuid())
  userId    String
  problemId String
  mode      PracticeMode
  status    SessionStatus @default(ACTIVE)
  startedAt DateTime @default(now())
  completedAt DateTime?

  // Phase data
  exploreData    Json? // ExplorePatternData[]
  planningData   Json? // PlanningData
  implData       Json? // ImplementationData
  reflectionData Json? // ReflectionData
  phaseTimings   Json? // { explore: number, planning: number, implementation: number, reflection: number }
  totalScore     Float?
  phaseScores    Json? // Phase scores

  // Relationships
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  problem Problem @relation(fields: [problemId], references: [id], onDelete: Cascade)
  scores  PhaseScore[]
  review  ReviewSession?

  @@map("practice_sessions")
}

model PhaseScore {
  id        String   @id @default(cuid())
  sessionId String
  userId    String
  phase     Phase
  score     Float    // 0-100
  details   Json?    // Detailed scoring breakdown
  createdAt DateTime @default(now())

  // Relationships
  session PracticeSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("phase_scores")
}

model Reflection {
  id        String   @id @default(cuid())
  userId    String
  sessionId String?  // Optional - can be standalone
  content   String
  tags      Json     // Tags for categorization
  createdAt DateTime @default(now())

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("reflections")
}

model DailyPlan {
  id        String   @id @default(cuid())
  userId    String
  date      DateTime
  problems  Json     // Array of problem IDs with metadata
  completed Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@map("daily_plans")
}

model CustomProblem {
  id          String   @id @default(cuid())
  userId      String
  problemId   String   @unique
  title       String
  description String
  difficulty  Difficulty
  examples    Json
  constraints Json
  createdAt   DateTime @default(now())

  // Relationships
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  problem Problem @relation(fields: [problemId], references: [id], onDelete: Cascade)

  @@map("custom_problems")
}

model ReviewSession {
  id          String   @id @default(cuid())
  sessionId   String   @unique
  userId      String
  
  // Timing Analysis
  phaseTimings Json    // { explore: 120, planning: 300, implementation: 600 }
  totalTime    Int     // Total seconds
  
  // AI Analysis Results
  aiAnalysis   Json    // Comprehensive AI feedback
  strengths    Json    // Array of identified strengths
  weaknesses   Json    // Array of identified weaknesses
  recommendations Json // Specific improvement suggestions
  
  // Performance Metrics
  patternAccuracy    Float  // 0-1 score
  implementationScore Float // 0-1 score
  overallScore       Float  // 0-1 score
  
  createdAt DateTime @default(now())
  
  // Relationships
  session PracticeSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("review_sessions")
}

model UserAnalytics {
  id        String   @id @default(cuid())
  userId    String   @unique
  
  // Pattern Performance
  patternScores    Json // { "Two Pointers": 0.85, "DP": 0.62, ... }
  patternAttempts   Json // Count of attempts per pattern
  
  // Timing Analytics
  avgPhaseTimes     Json // Average time per phase
  speedImprovement  Json // Trend over time
  
  // Weakness Tracking
  commonMistakes    Json // Most frequent error types
  improvementAreas Json // Areas needing work
  
  // Overall Metrics
  totalSessions     Int
  avgSessionScore   Float
  readinessScore    Float // 0-100
  
  lastUpdated DateTime @updatedAt
  
  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_analytics")
}

// Enums
enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum PracticeMode {
  TIMED
  UNTIMED
  STRICT
}

enum SessionStatus {
  ACTIVE
  COMPLETED
  ABANDONED
}

enum Phase {
  EXPLORE
  PLANNING
  IMPLEMENTATION
  REFLECTION
}